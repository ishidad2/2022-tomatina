<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.ico">
  <meta name="keyword" content="トマティーナ,XYM,Symbol">
	<meta meta name="description" content="トマティーナ Monitorはxembook.tomatoモザイクのトランザクションを可視化するツールです">
	<link rel="canonical" href="https://ishidad2.github.io/2022-tomatina">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="@ishidad2">
	<meta name="twitter:title" content="トマティーナ Monitor">
	<meta name="twitter:description" content="トマティーナ Monitorはxembook.tomatoモザイクのトランザクションを可視化するツールです">
	<meta name="twitter:image" content="https://ishidad2.github.io/2022-tomatina/tomato.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="manifest" href="./manifest.json">
  <title>トマティーナ Monitor</title>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LS3K0HTFYK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LS3K0HTFYK');
</script>

<body>
  <header>
    <h1>トマティーナ Monitor</h1>
  </header>
  <section>
    <div class="container-fluid">
      <div class="row">
        <div class="tomatina-links">
          <ul>
            <li>トマティーナってなに！？<a href="https://twitter.com/xembook/status/1555023490742652929" target="_blank" rel="noopener noreferrer">(@xembook)</a></li>
            <li>Tomatina Walletでトマティーナ！<a href="https://twitter.com/mikunNEM/status/1558385436950536192" target="_blank" rel="noopener noreferrer">(@mikunNEM)</a></li>
            <li>toshi.tomatoを手に入れよう！<a href="https://twitter.com/toshiya_ma/status/1560514223322681352" target="_blank" rel="noopener noreferrer">(@toshiya_ma)</a></li>
            <li>法定通貨がトマト🍅になった時！？<a href="https://twitter.com/subarumanSP/status/1560509786822545409" target="_blank" rel="noopener noreferrer">(@subarumanSP)</a></li>
            <li>あなたがトマトと言ったから8月31日はトマティーナ記念日🍅😎<a href="https://twitter.com/HANABATA_KE/status/1559803077292863488" target="_blank" rel="noopener noreferrer">(@HANABATA_KE)</a></li>
            <li>NFTDriveEXでトマティーナ！！<a href="https://twitter.com/EUFjZEyIuzS9rIi/status/1560656061236776966" target="_blank" rel="noopener noreferrer">(@EUFjZEyIuzS9rIi)</a></li>
            <li>VR空間でもトマティーナ🍅<a href="https://twitter.com/feiton81118/status/1561563678994219009" target="_blank" rel="noopener noreferrer">(@feiton81118)</a></li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col col-sm-12 col-md-11 col-lg-8">
          <div class="date-area">
            🍅トランザクショングラフ (<span id="tomato_graph_update">****</span> 更新)
          </div>
          <canvas id="myChart" height="120"></canvas>
        </div>
        <div class="col">
          <div class="date-area">
            XEMBook🍅ランキング (<span id="ranking_update">****</span> 更新)
          </div>
          <div class="ranking">
            <div id="loading">
              <img src="./loading-s-17.gif" alt="">
            </div>
            <ul class="d-ranking-list" id="tomatoRanking">
            </ul>
          </div>
        </div>
        <!-- col end -->
      </div>
      <!-- row end -->
      <div class="row">
        <div class="col">
          <div class="date-area">
            現在の🍅保有者情報 (<span id="tomato_user_update">****</span> 更新)
          </div>
          <div class="tomato-user">
            xembook.tomato 保有者人数：<span id="xembook_tomato_user">***</span> 人
          </div>
          <div class="tomato-user">
            toshi.tomato 保有者人数：<span id="toshi_tomato_user">***</span> 人 (<a href="https://twitter.com/toshiya_ma/status/1560514223322681352" target="_blank" rel="noopener noreferrer">toshi.tomatoとは？！</a>)
          </div>
          <div class="tomato-user">
            toshi.tomato 未保有アカウント
            <ul class="toshi-tomato-userl-ist" id="toshi_tomato_user_list">
            </ul>
          </div>
          <div class="memo">
            ※トマティーナ Monitorはブロック高：<span id="startBlock"></span>～<span id="endBlock"></span>までのトランザクションをモニターします。
          </div>
        </div>
      </div>
    </div>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="https://xembook.github.io/nem2-browserify/symbol-sdk-pack-2.0.0.js"></script>
  <script src="https://ishidad2.github.io/symbol-node-util-browserify/symbol-node-util-1.0.9.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
  <script>
    const { getActiveNode } = require("/node_modules/symbol-node-util");
    const {
      NetworkType,
      RepositoryFactoryHttp,
      MosaicId,
      TransactionGroup,
      Listener,
      ReceiptType,
      TransactionType,
      MosaicRestrictionEntryType
    } = require("/node_modules/symbol-sdk");
    (async()=>{
      $('#tomato_graph_update').text(dayjs().format('HH:mm:ss'));

      let myChart;
      let labelVal = [dayjs().format('HH:mm:ss')];
      let tomatoCharCount = 0;
      let toshiTomatoChartCount = 0;
      let pageNumber = 0;
      const maxPage = 25;
      const updatetime = 3;
      
      // ===== 本番 ====
      const tomatinaMosaicId = "310378C18A140D1B";
      const toshiTomatoMosaicId = "613E6D0FC11F4530";
      const networkType = NetworkType.MAIN_NET;
      const node = await getActiveNode(NetworkType.MAIN_NET);
      const startBlock = 1529793; //https://clock.sfn.tools/symbol?block=1529793&lang=ja
      const endBlock = 1532672;   //https://clock.sfn.tools/symbol?block=1532672&lang=ja

      // ******** テスト用 ********
      // const tomatinaMosaicId = "224CEE82F56D5A8B";
      // const toshiTomatoMosaicId = "16D70B79689070DB";
      // const networkType = NetworkType.TEST_NET;
      // const node = await getActiveNode(NetworkType.TEST_NET);
      // const startBlock = 632642;
      // const endBlock = 640000;

      console.log("接続", node);
      $('#startBlock').text(startBlock);
      $('#endBlock').text(endBlock);

      const max = 40;
      const ctx = $('#myChart');

      const repo = new RepositoryFactoryHttp(node);
      const txRepo = repo.createTransactionRepository();
      const nsRepo = repo.createNamespaceRepository();
      const blockRepo = repo.createBlockRepository();
      const accountRepo = repo.createAccountRepository();
      const restrictRepo = repo.createRestrictionMosaicRepository();

      const epochAdjustment = await repo.getEpochAdjustment().toPromise();
      const wsEndpoint = node.replace('http', 'ws') + "/ws";
      const listener = new Listener(wsEndpoint,nsRepo,WebSocket);

      async function getTransfers(block){
        tomatoCharCount = 0;
        toshiTomatoChartCount = 0;
        try {
          const tx = await txRepo.search({
            height: block.height.compact(),
            group: TransactionGroup.Confirmed
          }).toPromise();
          await parseTxs(tx.data);
        } catch (error) {
          console.error(error);
        }
      }

      async function parseTxs(txs){
        for(tx of txs){
          //アグリゲートトランザクション判定
          if(tx.type === TransactionType.AGGREGATE_COMPLETE || tx.type === TransactionType.AGGREGATE_BONDED){
            //アグリゲートの場合、内部トランザクションを再取得
            const reTx = await txRepo.getTransaction(
              tx.transactionInfo.hash,
              TransactionGroup.Confirmed
            ).toPromise();
            console.log("== aggregateTx ==")
            //この関数を再帰的に呼び出し
            parseTxs(reTx.innerTransactions);  //再帰呼び出し
            console.log("-----------------")
          }else {
            if(tx.mosaics !== undefined){
              tx.mosaics.forEach(mosaic => {
                if(mosaic.id.toHex() === tomatinaMosaicId){
                  console.log("🍅モザイクのTx", tx);
                  tomatoCharCount++;
                }
                if(mosaic.id.toHex() === toshiTomatoMosaicId){
                  console.log("Toshi🍅モザイクのTx", tx);
                  toshiTomatoChartCount++;
                }
              });
            }
          }
        }
      }

      async function updateChart(block){
        if(myChart){
          const blockTime = dayjs((epochAdjustment * 1000) + block.timestamp.compact()).format("HH:mm:ss");
          console.log("blockTime", blockTime);
          let chartLabels = myChart.data.labels;
          let chartDatasets =  myChart.data.datasets;
          if( myChart.data.labels.length > max){
            chartLabels =  myChart.data.labels.slice( myChart.data.labels.length-max,  myChart.data.labels.length)
          }
          //ラベル書き換え
          myChart.data.labels = [...chartLabels, blockTime];

          await getTransfers(block);

          myChart.data.datasets.forEach((dataset) => {
            if( dataset.data.length > max){
              dataset.data.shift();
            }
            if(dataset.label === "xembook.tomato"){
              dataset.data.push(tomatoCharCount);
            }
            if(dataset.label === "toshi.tomato"){
              dataset.data.push(toshiTomatoChartCount);
            }
          });
          myChart.update();
          $('#tomato_graph_update').text(dayjs().format('HH:mm:ss'));
        }
      }
      
      function drawChart(){
        myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labelVal,
            datasets: [
              {
                label: 'xembook.tomato',
                data: [0],
                backgroundColor: 'rgba(0, 134, 197, 0.7)',
                borderColor: 'rgba(0, 134, 197, 1)',
                fill: false,
              },
              {
                label: 'toshi.tomato',
                data: [0],
                backgroundColor: 'rgba(255,128,64, 0.7)',
                borderColor: 'rgba(255,128,64, 1)',
                fill: false,
              }
            ]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            },
          }
        });
      }

      async function getTomatoTransaction(rank){
        pageNumber++;
        console.log("page", pageNumber);
        let lastHeight = 0;
        const criteria = {
          group: TransactionGroup.Confirmed,
          embedded: true,
          transferMosaicId: new MosaicId(tomatinaMosaicId),
          order: "desc",
          pageNumber: pageNumber
        }
        const txs = await txRepo.search(criteria).toPromise();
        let isLastPage = txs.isLastPage;
        for(tx of txs.data){
          //指定ブロック内の🍅トランザクションを計測
          const block_height = tx.transactionInfo.height.compact();
          if(endBlock >= block_height && startBlock <= block_height){
            rank.push(tx.signer.address.plain());
          }
          lastHeight = tx.transactionInfo.height.compact();
        }
        return [isLastPage, lastHeight];
      }

      function getBatchOfTransfers(){
        $('#loading').show();
        pageNumber = 0;
        let rank = [];
        let timer = setInterval( async function(){
          [isLastPage, height] = await getTomatoTransaction(rank);
          console.log("🍅履歴取得開始" + dayjs().format(), isLastPage, height);
          if (isLastPage || startBlock >= height || maxPage <= pageNumber){
            let rankings = {};
            for (let i = 0; i < rank.length; i++) {
              var elm = rank[i];
              rankings[elm] = (rankings[elm] || 0) + 1;
            }
            let result = Object.entries(rankings).map(([key, value]) => ({"address": key, "txNum": value}));

            let tomatinaRanking = result.sort(function(a, b){
              return (a.txNum > b.txNum) ? -1 : 1;
            });
            $('#tomatoRanking').empty();
            tomatinaRanking.forEach((el) => {
              console.log(el);
              $('#tomatoRanking').append('<li class="d-rank">' + el.address + " (" + el.txNum + ')</li>');
            })
            $('#ranking_update').text(dayjs().format('HH:mm:ss'));
            $('#loading').hide();
            clearInterval(timer);
          }
        },1000);
      }

      async function getTomatoUser(){
        let pageNumber = 0;
        let xembookTomatoUser = 0;
        let timer1 = setInterval( async function(){
          pageNumber++;
          let _mosaic_owned = await accountRepo.search(
            {
              pageNumber: pageNumber,
              mosaicId: new MosaicId(tomatinaMosaicId),
            }
          ).toPromise();
          xembookTomatoUser += _mosaic_owned.data.length;
          if (_mosaic_owned.isLastPage){
            $('#xembook_tomato_user').text(xembookTomatoUser);
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
            clearInterval(timer1);
          }
        },1000);
      }
      async function getToshiTomatoUser(){
        let pageNumber = 0;
        let toshiTomatoUser = 0;
        let timer1 = setInterval( async function(){
          pageNumber++;
          let _mosaic_owned = await accountRepo.search(
            {
              pageNumber: pageNumber,
              mosaicId: new MosaicId(toshiTomatoMosaicId),
            }
          ).toPromise();
          toshiTomatoUser += _mosaic_owned.data.length;
          if (_mosaic_owned.isLastPage){
            $('#toshi_tomato_user').text(toshiTomatoUser);
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
            clearInterval(timer1);
          }
        },1000);
      }

      async function getTomatoUserList(){
        let pageNumber = 0;
        $('#tomatoRanking').empty();
        let timer1 = setInterval( async function(){
          pageNumber++;
          let _mosaic_restriction = await restrictRepo.search(
            {
              pageNumber: pageNumber,
              mosaicId: new MosaicId(toshiTomatoMosaicId),
            }
          ).toPromise();
          _mosaic_restriction.data.forEach((restriction) => {
            if(restriction.entryType === MosaicRestrictionEntryType.ADDRESS){
              //アカウント情報取得
              accountRepo.getAccountInfo(restriction.targetAddress).subscribe((accountInfo) => {
                let mosaic_flg = false;
                accountInfo.mosaics.forEach((mosaic) => {
                  if(mosaic.id.toHex() === toshiTomatoMosaicId){
                    mosaic_flg = true;
                  }
                });
                if(!mosaic_flg){
                  $('#toshi_tomato_user_list').append('<li class="address">' + accountInfo.address.plain() + '</li>');
                }
              });
            }
          })
          
          if (_mosaic_restriction.isLastPage){
            $('#tomato_user_update').text(dayjs().format('HH:mm:ss'));
            clearInterval(timer1);
          }
        },1000);
      }

      drawChart();
      //初回実行
      getBatchOfTransfers();
      getTomatoUser();
      getToshiTomatoUser();
      getTomatoUserList();

      setInterval( function(){
        getBatchOfTransfers();
        getTomatoUser();
        getToshiTomatoUser();
        getTomatoUserList();
      }, 60000 * updatetime); //3分毎

      listener.open().then(() => {
        console.log('listner open')
        listener.newBlock().subscribe((block) => {
          updateChart(block);
        });

        listener.webSocket.onclose = function(){
          console.log("listener onclose");
        }
        listenNewBlock();
      });

      function listenNewBlock(){
        listener.newBlock();
        setTimeout(listenNewBlock, 50000);
      }
    })();
  </script>
</body>
</html>